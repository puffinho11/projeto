name: CD - Deploy no Minikube

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Clonar repositÃ³rio
        uses: actions/checkout@v3

      - name: âš™ï¸ Instalar kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

      - name: ðŸ” Configurar acesso ao Kubernetes
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        run: |
          echo "$KUBE_CONFIG_DATA" | base64 --decode > kubeconfig.yaml
          export KUBECONFIG=kubeconfig.yaml
          kubectl cluster-info

      - name: ðŸš€ Fazer deploy da nova imagem
        run: |
          kubectl set image deployment/monitor monitor=puff10/projeto:latest --namespace=default
          kubectl rollout status deployment/monitor --namespace=default

      - name: âœ… Verificar pods apÃ³s o deploy
        run: |
          kubectl get pods -n default
